version: 2.1
orbs:
    node: circleci/node@4.2.1

jobs:
    test:
        parameters:
            node-version:
                type: string
        executor:
            name: node/default
        steps:
            - checkout
            - node/install:
                  node-version: << parameters.node-version >>
                  install-npm: false
            - node/install-packages
            - run: npm test -- --ci --runInBand --coverage
            - store_test_results:
                  path: test-results/junit
            - store_artifacts:
                  path: test-results/junit
            - store_artifacts:
                  path: test-results/coverage

    release:
        executor:
            name: node/default
        steps:
            - checkout
            - node/install-packages
            - run: npm run build
            - run: npm run semantic-release

workflows:
    build-and-test:
        jobs:
            - test:
                  matrix:
                      parameters:
                          node-version:
                              - "15"
                              - "14"
                              - "12"
                              - "10"

            - release:
                  requires:
                      - test
